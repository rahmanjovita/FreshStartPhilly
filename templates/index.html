<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fresh Start Philly</title>

        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <!-- Leaflet JS (this must come before your custom script that uses L) -->
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <style>
            #map {
                height: 500px;
                width: 100%;
            }
            #results {
                margin-top: 20px;
                padding: 10px;
                background-color: #f9f9f9;
                border-radius: 5px;
            }
            .resource {
                padding: 10px;
                border-bottom: 1px solid #ddd;
            }
        </style>
    
  </head>

  <div id="header">
    <!-- Link to the homepage (index.html) -->
    <a href="{{url_for('home')}}">
        <!-- Logo Image -->
        <img src="../static/freshstartphillylogo.png" alt="Our Logo">
    </a> 

    <!-- Navigation Links Section -->
    <div id="nav-links">
        <a href="{{url_for('home')}}">Home</a>
        <a href="{{url_for('about')}}">About</a>
    </div>
</div>

    <h1>Find Resources in Philadelphia</h1>

    <!-- Location input form -->
    <label for="location">Enter Your Zip Code:</label>
    <input type="text" id="location" placeholder="Enter your location">
    <label for="location" >&ensp; or &ensp; </label>
    <button onclick="getLocation()">Get Your Location</button>

    

    <h2>Check the resources you'd like to find:</h2>

    <!-- Checkboxes for different needs -->
    <div>
      <input type="checkbox" id="food" name="needs" value="food" />
      <label for="food">Food</label>
    </div>
    <div>
      <input type="checkbox" id="housing" name="needs" value="housing" />
      <label for="housing">Housing</label>
    </div>
    <div>
      <input
        type="checkbox"
        id="mentalHealth"
        name="needs"
        value="mental_health"
      />
      <label for="mentalHealth">Mental Health</label>
    </div>
    <div>
      <input type="checkbox" id="jobSearch" name="needs" value="job_search" />
      <label for="jobSearch">Job Search</label>
    </div>
    <div>
      <input type="checkbox" id="childCare" name="needs" value="child_care" />
      <label for="childCare">Child Care</label>

    </div>
    <div>
      <input
        type="checkbox"
        id="medicalCare"
        name="needs"
        value="medical_care"
      />
      <label for="medicalCare">Medical Care</label>

    </div>
    <div>
      <input type="checkbox" id="education" name="needs" value="education" />
      <label for="education">Education</label>
      <br>
    </br>
    </div>

    <!-- Submit button -->
    <button onclick="fetchResources()">Find Resources</button>

    <!-- Display results -->
    <pre id="results"></pre>

    <!-- Leaflet map -->
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>


    <script>
        let map;

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById("location").value = `Lat: ${position.coords.latitude}, Lon: ${position.coords.longitude}`;
                });
            }
        }


      function fetchResources() {
        // Get the user's location
        let location = document.getElementById("location").value;

        // Get the selected needs (checkboxes that are checked)
        let needs = [];
        const checkboxes = document.querySelectorAll(
          'input[name="needs"]:checked'
      );
        checkboxes.forEach((checkbox) => {
          needs.push(checkbox.value);
        });
    }  
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    // Display the location in the input field
                    document.getElementById("location").value = `Lat: ${latitude}, Lon: ${longitude}`;
                }, function(error) {
                    console.error('Error occurred. Error code: ' + error.code);
                    alert("Unable to retrieve your location. Please enter it manually.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function fetchResources() {
            // Get the user's location
            let location = document.getElementById("location").value;
            
            // Get the selected needs (checkboxes that are checked)
            let needs = [];
            const checkboxes = document.querySelectorAll('input[name="needs"]:checked');
            checkboxes.forEach((checkbox) => {
                needs.push(checkbox.value);
            });

        // Send location and needs to the server via POST request
        fetch("/get_resources", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ location, needs }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Display the results from the server
            document.getElementById("results").innerText = data.summary;
            displayMap(data.resources);

          })
          .catch((error) => console.error("Error:", error));
      }

      function displayMap(resources) {
            if (!map) {
                map = L.map('map').setView([39.9526, -75.1652], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }

            resources.forEach(resource => {
                L.marker([resource.lat, resource.lng])
                    .addTo(map)
                    .bindPopup(`<b>${resource.name}</b><br>${resource.description}`);
            });
        }

    </script>
  </body>
</html>
